<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Paneli</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Ace Editor CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-dracula.min.css">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #f3f4f6;
            padding-top: 70px;
        }
        
        .ace_editor {
            height: 300px !important;
            border-radius: 0.5rem;
            font-size: 0.9rem;
        }

        .navbar-dark-custom {
            background-color: #1f2937 !important;
            border-bottom: 1px solid #374151;
        }

        .navbar-dark-custom .navbar-brand,
        .navbar-dark-custom .nav-link {
            color: #f3f4f6 !important;
        }

        .approval-card {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .approval-card .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .badge-warning {
            background-color: #f59e0b !important;
            color: #1f2937 !important;
        }

        .badge-danger {
            background-color: #dc2626 !important;
            color: white !important;
        }

        .query-container {
            background-color: #374151;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .query-text {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.875rem;
            color: #e5e7eb;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .table-dark-custom {
            background-color: #1f2937;
            color: #f3f4f6;
        }

        .table-dark-custom th {
            background-color: #111827;
            border-color: #374151;
        }

        .table-dark-custom td {
            border-color: #374151;
        }

        .table-dark-custom tbody tr:hover {
            background-color: #374151;
        }

        .results-container {
            background-color: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-top: 2rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .download-buttons {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-dark-custom py-2 px-4 shadow-lg fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand text-xl font-bold" href="/">WEBQUERY - Admin Panel</a>
            <div class="d-flex">
                <button onclick="window.location.href='/home'" class="btn btn-outline-light btn-sm me-2">
                    Ana Sayfa
                </button>
                <button onclick="logout()" class="btn btn-outline-danger btn-sm">
                    Çıkış Yap
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        <h1 class="text-3xl font-bold mb-6 text-center">Admin Panel - Sorgu Onayları</h1>
        
        <!-- Onay Bekleyen Sorgular -->
        <div class="row">
            <div class="col-12">
                <h2 class="text-xl font-semibold mb-4">Onay Bekleyen Sorgular</h2>
                <div id="pendingQueries">
                    <!-- Pending queries will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Query Results -->
        <div id="queryResults" class="results-container" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="text-lg font-semibold text-white">Sorgu Sonuçları</h3>
                <div class="download-buttons">
                    <button class="btn btn-success btn-sm me-2" onclick="downloadCSV()">
                        CSV İndir
                    </button>
                    <button class="btn btn-info btn-sm" onclick="downloadExcel()">
                        Excel İndir
                    </button>
                </div>
            </div>
            <div id="queryInfo" class="mb-3 text-light"></div>
            <div id="resultsTable" class="table-responsive">
                <!-- Results table will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div class="modal fade" id="approvalModal" tabindex="-1" aria-labelledby="approvalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-gray-800 text-gray-100" style="background-color: #1f2937 !important; color: #f3f4f6 !important;">
                <div class="modal-header" style="border-bottom: 1px solid #374151;">
                    <h5 class="modal-title text-white" id="approvalModalLabel">Sorgu Detayları ve Önizleme</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="queryEditor" style="height: 300px; border-radius: 0.5rem;"></div>
                    <div class="mt-3 text-white">
                        <p><strong>Kullanıcı:</strong> <span id="modalUsername" class="text-info"></span></p>
                        <p><strong>Sunucu:</strong> <span id="modalServer" class="text-info"></span></p>
                        <p><strong>Veritabanı:</strong> <span id="modalDatabase" class="text-info"></span></p>
                        <p><strong>Risk Türü:</strong> <span id="modalRiskType" class="badge bg-danger"></span></p>
                    </div>
                    
                    <!-- Preview Button -->
                    <div class="mt-3">
                        <button type="button" class="btn btn-info" onclick="previewQuery()" id="previewButton">
                            <i class="bi bi-eye"></i> Sorgu Sonuçlarını Önizle
                        </button>
                    </div>
                    
                    <!-- Preview Results Container -->
                    <div id="previewResults" style="display: none; margin-top: 1.5rem;">
                        <h6 class="text-white mb-2">Önizleme Sonuçları:</h6>
                        <div id="previewInfo" class="text-light mb-2"></div>
                        <div id="previewTableContainer" class="table-responsive" style="max-height: 400px; overflow-y: auto; background-color: #111827; border-radius: 0.5rem; padding: 1rem;">
                            <!-- Preview table will be inserted here -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #374151;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-danger" onclick="rejectQuery()">Reddet</button>
                    <button type="button" class="btn btn-warning" onclick="approveQueryNotExecutable()">Onayla (Çalıştırılamaz)</button>
                    <button type="button" class="btn btn-success" onclick="approveQueryExecutable()">Onayla ve Çalıştırılabilir Yap</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/mode-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/theme-dracula.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        let currentApprovalData = null;
        let modalEditor = null;
        let currentQueryResults = null;

        // Add global fetch wrapper for authentication handling
        const authenticatedFetch = async (url, options = {}) => {
            try {
                const response = await fetch(url, {
                    ...options,
                    credentials: 'include'
                });
                
                if (response.status === 401) {
                    // Token is invalid or missing, redirect to login
                    window.location.href = '/login';
                    return null;
                }
                
                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadPendingQueries();
            initializeModalEditor();
        });

        function initializeModalEditor() {
            ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/');
            modalEditor = ace.edit("queryEditor");
            modalEditor.setTheme("ace/theme/dracula");
            modalEditor.session.setMode("ace/mode/sql");
            modalEditor.setOptions({
                showLineNumbers: true,
                tabSize: 2,
                wrap: true,
                readOnly: true
            });
        }

        async function loadPendingQueries() {
            try {
                const response = await authenticatedFetch('/api/admin/queries_to_approve');
                if (!response) return; // Redirected to login
                
                if (!response.ok) {
                    throw new Error('Failed to fetch pending queries');
                }
                const data = await response.json();
                renderPendingQueries(data.waiting_approvals || []);
            } catch (error) {
                console.error('Error loading pending queries:', error);
                document.getElementById('pendingQueries').innerHTML = 
                    '<div class="alert alert-danger">Onay bekleyen sorgular yüklenemedi.</div>';
            }
        }

        function renderPendingQueries(queries) {
            const container = document.getElementById('pendingQueries');
            
            if (queries.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Onay bekleyen sorgu bulunmamaktadır.</div>';
                return;
            }

            container.innerHTML = queries.map(query => `
                <div class="approval-card">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="mb-1 text-white">${query.username}</h5>
                            <p class="text-light mb-1"><strong>Sunucu:</strong> ${query.servername || 'Bilinmeyen'}</p>
                            <p class="text-light mb-1"><strong>Veritabanı:</strong> ${query.database}</p>
                            <span class="badge badge-warning">${query.status}</span>
                            ${query.risk_type ? `<span class="badge badge-danger ms-2">${query.risk_type}</span>` : ''}
                        </div>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="showApprovalModal(${JSON.stringify(query).replace(/"/g, '&quot;')})">
                                Detay Görüntüle
                            </button>
                        </div>
                    </div>
                    <div class="query-container">
                        <div class="query-text">${query.query}</div>
                    </div>
                </div>
            `).join('');
        }

        function showApprovalModal(queryData) {
            currentApprovalData = queryData;
            
            document.getElementById('modalUsername').textContent = queryData.username;
            document.getElementById('modalServer').textContent = queryData.servername || 'Bilinmeyen';
            document.getElementById('modalDatabase').textContent = queryData.database;
            document.getElementById('modalRiskType').textContent = queryData.risk_type || 'Bilinmeyen';
            
            modalEditor.setValue(queryData.query, -1);
            
            // Reset preview section
            document.getElementById('previewResults').style.display = 'none';
            document.getElementById('previewButton').disabled = false;
            document.getElementById('previewTableContainer').innerHTML = '';
            
            const modal = new bootstrap.Modal(document.getElementById('approvalModal'));
            modal.show();
        }

        async function previewQuery() {
            if (!currentApprovalData) return;
            
            const previewButton = document.getElementById('previewButton');
            previewButton.disabled = true;
            previewButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Yükleniyor...';
            
            try {
                const response = await authenticatedFetch(`/api/admin/execute_for_preview/${currentApprovalData.workspace_id}`, {
                    method: 'POST'
                });
                
                if (!response) return; // Redirected to login
                
                if (response.ok) {
                    const result = await response.json();
                    displayPreviewResults(result);
                    showToast('Önizleme başarıyla yüklendi!', 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Preview failed');
                }
            } catch (error) {
                console.error('Error previewing query:', error);
                showToast(`Önizleme hatası: ${error.message}`, 'error');
            } finally {
                previewButton.disabled = false;
                previewButton.innerHTML = '<i class="bi bi-eye"></i> Sorgu Sonuçlarını Önizle';
            }
        }

        function displayPreviewResults(result) {
            const previewResults = document.getElementById('previewResults');
            const previewInfo = document.getElementById('previewInfo');
            const previewTableContainer = document.getElementById('previewTableContainer');

            // Update preview info
            previewInfo.innerHTML = `
                <p><strong>Satır Sayısı:</strong> ${result.row_count} ${result.truncated ? '(Önizleme için kısıtlı)' : ''}</p>
            `;

            // Create table
            if (result.data && result.data.length > 0) {
                const columns = Object.keys(result.data[0]);
                let tableHtml = `
                    <table class="table table-dark-custom table-striped table-sm">
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${result.data.map(row => 
                                `<tr>${columns.map(col => `<td>${row[col] !== null ? row[col] : '<span class="text-muted">NULL</span>'}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                `;
                previewTableContainer.innerHTML = tableHtml;
            } else {
                previewTableContainer.innerHTML = '<p class="text-info">Sorgu sonucu boş.</p>';
            }

            previewResults.style.display = 'block';
        }

        async function approveQueryExecutable() {
            await approveQuery(true);
        }

        async function approveQueryNotExecutable() {
            await approveQuery(false);
        }

        async function approveQuery(showResults = true) {
            if (!currentApprovalData) return;
            
            try {
                const response = await authenticatedFetch(`/api/admin/approve_query/${currentApprovalData.workspace_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        show_results: showResults
                    })
                });
                
                if (!response) return; // Redirected to login
                
                if (response.ok) {
                    const result = await response.json();
                    bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
                    await loadPendingQueries();
                    const message = showResults 
                        ? 'Sorgu onaylandı ve çalıştırılabilir yapıldı!' 
                        : 'Sorgu onaylandı (çalıştırılamaz olarak işaretlendi)';
                    showToast(message, 'success');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Approval failed');
                }
            } catch (error) {
                console.error('Error approving query:', error);
                showToast(`Onaylama hatası: ${error.message}`, 'error');
            }
        }

        async function rejectQuery() {
            if (!currentApprovalData) return;
            
            try {
                const response = await authenticatedFetch(`/api/admin/reject_query/${currentApprovalData.workspace_id}`, {
                    method: 'POST'
                });
                
                if (!response) return; // Redirected to login
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('approvalModal')).hide();
                    await loadPendingQueries();
                    showToast('Sorgu reddedildi!', 'warning');
                    
                    // Hide results if visible
                    document.getElementById('queryResults').style.display = 'none';
                } else {
                    throw new Error('Rejection failed');
                }
            } catch (error) {
                console.error('Error rejecting query:', error);
                showToast('Sorgu reddedilirken hata oluştu!', 'error');
            }
        }

        function displayQueryResults(result) {
            currentQueryResults = result;
            const resultsContainer = document.getElementById('queryResults');
            const queryInfo = document.getElementById('queryInfo');
            const resultsTable = document.getElementById('resultsTable');

            // Update query info
            queryInfo.innerHTML = `
                <p><strong>Sunucu:</strong> ${result.servername}</p>
                <p><strong>Veritabanı:</strong> ${result.database}</p>
                <p><strong>Toplam Satır:</strong> ${result.row_count}</p>
                <p><strong>Sorgu:</strong></p>
                <div class="query-container">
                    <div class="query-text">${result.query}</div>
                </div>
            `;

            // Create table
            if (result.data && result.data.length > 0) {
                const columns = Object.keys(result.data[0]);
                let tableHtml = `
                    <table class="table table-dark-custom table-striped">
                        <thead>
                            <tr>
                                ${columns.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${result.data.map(row => 
                                `<tr>${columns.map(col => `<td>${row[col] !== null ? row[col] : 'NULL'}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                `;
                resultsTable.innerHTML = tableHtml;
            } else {
                resultsTable.innerHTML = '<p class="text-info">Sorgu sonucu boş.</p>';
            }

            resultsContainer.style.display = 'block';
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadCSV() {
            if (!currentQueryResults || !currentQueryResults.data || currentQueryResults.data.length === 0) {
                showToast('İndirilecek veri bulunamadı!', 'error');
                return;
            }

            const data = currentQueryResults.data;
            const columns = Object.keys(data[0]);
            
            let csvContent = columns.join(',') + '\n';
            data.forEach(row => {
                const values = columns.map(col => {
                    const value = row[col];
                    if (value === null) return 'NULL';
                    if (typeof value === 'string' && value.includes(',')) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                });
                csvContent += values.join(',') + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `query_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`;
            link.click();
        }

        function downloadExcel() {
            if (!currentQueryResults || !currentQueryResults.data || currentQueryResults.data.length === 0) {
                showToast('İndirilecek veri bulunamadı!', 'error');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(currentQueryResults.data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Query Results');
            
            const filename = `query_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        function showToast(message, type = 'success') {
            // Create toast element
            const toastId = `toast-${Date.now()}`;
            const toastHtml = `
                <div class="toast toast-${type}" role="alert" id="${toastId}" style="position: fixed; top: 80px; right: 20px; z-index: 1055;">
                    <div class="toast-header bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'} text-white">
                        <strong class="me-auto">${type === 'success' ? 'Başarılı' : type === 'warning' ? 'Uyarı' : 'Hata'}</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body bg-dark text-white">
                        ${message}
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', () => {
                toastElement.remove();
            });
        }

        async function logout() {
            try {
                const response = await authenticatedFetch('/api/logout', { method: 'POST' });
                if (response && response.ok) {
                    window.location.href = '/login';
                } else if (!response) {
                    // Already redirected
                    return;
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    </script>
</body>
</html>
